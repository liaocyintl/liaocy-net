---
title: K8S Memo
authors: liaocy
tags: 
- Kubernetes
- k8s
- k8s-tutorial
---

import { Mermaid } from 'mdx-mermaid/Mermaid'

This is a note of the Kubernetes tutorial.

## References

1. [Kubernetes](https://kubernetes.io/)
1. [Kubernetes tutorial (Chinese)](https://youtu.be/W3V-VgTjDjo)

## Physical Structure

### Single Master Node

<Mermaid chart={`
graph LR
  master[Master 192.168.8.21]
  node1[Node1 192.168.8.31]
  node2[Node2 192.168.8.32]
  node3[Node2 192.168.8.33]
  master --> node1
  master --> node2
  master --> node3
`} />

### High-Availability Master Nodes

## Build K8S Cluster via Kubeadm

### OS
[CentOS-7-x86_64-Minimal-2009.iso](https://ftp.riken.jp/Linux/centos/7.9.2009/isos/x86_64/)

### Install Tools (ALL Nodes)

```bash On
# Install tools
yum install -y wget
yum install -y nano
yum install net-tools
```

### Close Firewall (ALL Nodes)

```bash
systemctl stop firewalld
systemctl disable firewalld
```

### Close swap (ALL Nodes)

```bash
swapoff -a
sed -ri 's/.*swap.*/#&/' /etc/fstab
```

### Set hostnames (ALL Nodes Individually)

On master:
```bash
hostnamectl set-hostname kube-master
```

On node1:
```bash
hostnamectl set-hostname kube-node1
```

On node2:
```bash
hostnamectl set-hostname kube-node2
```

On node3:
```bash
hostnamectl set-hostname kube-node3
```

### Set hosts (Master Node)

```bash
nano /etc/hosts
```

Fill in the following contents:
```text
192.168.8.21 kube-master
192.168.8.31 kube-node1
192.168.8.32 kube-node2
192.168.8.33 kube-node3
```

### Write Kube Traffic in iptables (All Nodes)

```bash
cat <<EOF > /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF

sysctl --system
```

### Install Docker (All Nodes)

```bash
yum install -y yum-utils
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum install -y docker-ce-18.06.1.ce-3.el7 docker-ce-cli-18.06.1.ce-3.el7 containerd.io docker-compose-plugin
systemctl enable docker && systemctl start docker
docker --version
```

### Install Kubelet (All Nodes)

```bash
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF

setenforce 0
sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0
systemctl enable kubelet

```

### Init Kube Master Node (Master Only)

```bash
kubeadm init --apiserver-advertise-address=192.168.8.21 --service-cidr=10.96.0.0/12 --pod-network-cidr=10.244.0.0/16

mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config
kubectl get nodes
```

The token is only valid for 24-hours. You can use the following command to generate a new token.
```bash
kubeadm token create --print-join-command
```

### Install flannel plugin (Master Only)

```bash
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
nano kube-flannel.yml
```

Modify `kube-flannel.yml` as following: [ref.](https://none06.hatenadiary.org/entry/2022/05/28/025115)

![alt](imgs/k8s-memo/2022-06-06-11-01-22.png "title")

```bash
$ kubectl apply -f kube-flannel.yml
$ kubectl get pods -n kube-system
$ kubectl get nodes
```

### Install Slave Nodes (All Slave Nodes)

This command should be copied from the contents that the master node generated.

```bash
 kubeadm join 192.168.8.21:6443 --token fxm6sy.jsw1uyarkx2fzsnw \
    --discovery-token-ca-cert-hash sha256:77c6f969d3e43942e4dea3b3c413ac9178fe89a2a6ac1a98254593eba574719e
```

### Startup Test Nginx Pod (Master Only)

```bash
kubectl create deployment nginx --image=nginx
kubectl get pods
kubectl expose deployment nginx --port=80 --type=NodePort
kubectl get pod, svc
kubectl get pods -A -o wide
```

Then you can access the Nginx service via the URL from any node.

http://<node_ip>:<exposed_port>/

## Build K8S Cluster via Binary

pending
